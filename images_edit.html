<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>이미지 수정/삭제</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- 파비콘 아이콘들 (상대경로(./) 사용 -->
    <link rel="icon" href="./favicon.ico?v=2" />

    <link
      rel="icon"
      type="image/png"
      sizes="36x36"
      href="./favicons/android-icon-36x36.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="48x48"
      href="./favicons/android-icon-48x48.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="72x72"
      href="./favicons/android-icon-72x72.png"
    />

    <link
      rel="apple-touch-icon"
      sizes="32x32"
      href="./favicons/apple-icon-32x32.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="./favicons/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="./favicons/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="./favicons/apple-icon-72x72.png"
    />

    <!-- 웹사이트 매니페스트 (상대경로(./) 사용  -->
    <link rel="manifest" href="./manifest.json" />

    <!-- Ms브라우저 설정 파일 (상대경로(./) 사용  -->
    <meta name="msapplication-config" content="./browserconfig.xml" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="./ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">



</head>

<body>
  <h2>이미지 수정/삭제</h2>

  <img id="preview" width="300"><br><br>

  <label>요약 수정:</label><br>
  <input type="text" id="summary"><br><br>

  <label>새 이미지 선택(선택사항):</label><br>
  <input type="file" id="newImage"><br><br>

  <button id="saveBtn">수정 저장</button>
  <button id="deleteBtn" style="color:red;">삭제</button>

  <p id="status"></p>

  <script type="module">
    import { db, storage } from "./firebase-config.js";
    import {
      ref, update, remove, get
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import {
      ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const id = new URLSearchParams(location.search).get("id");
    const status = document.getElementById("status");
    const preview = document.getElementById("preview");
    const summaryInput = document.getElementById("summary");

    const dataRef = ref(db, "images/" + id);

    // 기존 데이터 불러오기
    get(dataRef).then(snap => {
      const data = snap.val();
      preview.src = data.imageUrl;
      summaryInput.value = data.summary;
    });

    // 수정 저장
    document.getElementById("saveBtn").addEventListener("click", async () => {
      let newImageUrl = null;
      const file = document.getElementById("newImage").files[0];

      if (file) {
        const storageRef = sRef(storage, "images/" + file.name);
        await uploadBytes(storageRef, file);
        newImageUrl = await getDownloadURL(storageRef);
      }

      await update(dataRef, {
        summary: summaryInput.value,
        ...(newImageUrl && { imageUrl: newImageUrl })
      });

      status.textContent = "수정 완료!";
    });

    // 삭제
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (!confirm("정말 삭제하시겠습니까?")) return;

      await remove(dataRef);

      alert("삭제 완료!");
      location.href = "images_view.html";
    });
  </script>
</body>
</html>
