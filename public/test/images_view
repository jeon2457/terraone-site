<?php
// ✅ 이 페이지는 사용내역서 이미지 열람 페이지입니다. 
require 'php/db-connect.php';  // DB 연결
date_default_timezone_set('Asia/Seoul');

try {
    $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("DB 연결 실패: " . $e->getMessage());
}

$today = date('Y/m/d H:i');
$months = range(1, 12);
$currentMonth = isset($_GET['month']) ? $_GET['month'] : date('n');

// 선택된 월의 이미지 가져오기 (최신순)
$stmt = $pdo->prepare("SELECT * FROM images WHERE MONTH(date) = ? ORDER BY date DESC");
$stmt->bindParam(1, $currentMonth);
$stmt->execute();
$images = $stmt->fetchAll(PDO::FETCH_ASSOC);
?>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>영수증보기</title>
<link rel="stylesheet" href="css/images_view.css" />
<link rel="manifest" href="manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="theme-color" content="#ffffff">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<style>
th, td { text-align: center !important; vertical-align: middle !important; }
.addr_copy { display:inline-block; padding:2px 8px; border:1px solid #000; border-radius:4px; background-color:#f8f9fa; margin-right:10px; }
.addr_copy:hover { background-color:#e9ecef; }
.modal-body p { margin-bottom:0; }
.modal-body .next-line { display:block; margin-top:10px; }
.thumbnail { max-width:150px; max-height:150px; }
.text-month { margin-top:20px; margin-bottom:10px; }
.text-month .btn.active { font-weight:bold; background-color:#198754; color:white; }
.notice { margin-bottom:15px; color:#555; }
.big_image a { text-decoration:none; color:#0d6efd; }
.big_image a:hover { text-decoration:underline; }
</style>
</head>
<body class="p-3">

<div>오늘의 날짜: <?= $today ?></div>

<div class="text-month">
<?php foreach($months as $month): 
    $active = ($month == $currentMonth) ? 'active' : '';
?>
    <a class="btn btn-sm <?= $active ?>" href="?month=<?= $month ?>"><?= $month ?> 월</a>
<?php endforeach; ?>
</div>

<div class="notice">[알림] 위의 해당되는 X월 버튼을 클릭하면 이미지를 볼 수 있습니다.</div>

<table class="table table-bordered table-striped align-middle">
<thead>
<tr>
<th>No</th>
<th>날짜</th>
<th>이미지</th>
<th>요약</th>
<th>내려받기</th>
</tr>
</thead>
<tbody>
<?php 
$counter = 1;
foreach($images as $image):
    $imagePath = "./data/profile/" . basename($image['photo']);
    $formattedDate = date('Y-m-d H:i', strtotime($image['date']));
?>
<tr>
<td><?= $counter ?></td>
<td><?= $formattedDate ?></td>
<td><img src="<?= $imagePath ?>" alt="Image" class="thumbnail"></td>
<td><?= htmlspecialchars($image['notice']) ?></td>
<td class="big_image"><a href="#" class="download-link" data-idx="<?= $image['idx'] ?>">다운로드</a></td>
</tr>
<?php $counter++; endforeach; ?>
</tbody>
</table>

<!-- 모달 -->
<div class="modal fade" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downloadModalLabel">[[ 이미지 다운로드 방법안내 ]]</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>(방법1) 이미지를 길게 터치 후 "이미지 저장" 선택</p>
        <p class="next-line">(방법2) 이미지를 확대 후 캡쳐 저장</p>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'));
    document.body.addEventListener("click", function(e){
        if(e.target.classList.contains("download-link")){
            e.preventDefault();
            downloadModal.show();
        }
    });
});
</script>

</body>
</html>
