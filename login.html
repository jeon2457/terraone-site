<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ìë¡œê·¸ì¸</title>

  <!-- íŒŒë¹„ì½˜ -->
  <link rel="icon" href="./favicons/favicon.png?v=2" />
  <link rel="icon" type="image/png" sizes="36x36" href="./favicons/android-icon-36x36.png" />
  <link rel="icon" type="image/png" sizes="48x48" href="./favicons/android-icon-48x48.png" />
  <link rel="icon" type="image/png" sizes="72x72" href="./favicons/android-icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="32x32" href="./favicons/apple-icon-32x32.png">
  <link rel="apple-touch-icon" sizes="57x57" href="./favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="./favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="./favicons/apple-icon-72x72.png">


  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- ì‚¬ìš©ì ì •ì˜ CSS -->
  <link rel="stylesheet" href="./css_firebase/login.css">
</head>
<body>
  <div class="container mt-3">
    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-5">
        <!-- ìƒë‹¨ ì•ˆë‚´ ë©”ì‹œì§€ -->
        <div class="text-left mb-3 py-4" 
             style="color: #fff; background-color: #333; border-radius: 12px; padding-left: 20px; padding-right: 20px;">
          <strong>ğŸ”’ ê´€ë¦¬ì ì „ìš© ë¡œê·¸ì¸</strong><br>
          <small>admin : te****** / 7****</small>
        </div>
        <div class="card shadow-lg p-4">
          <div class="login-icon">
            <img src="./image/clova.jpg" alt="ë¡œê·¸ì¸ ì•„ì´ì½˜">
          </div>
          <h2 class="card-title text-center mb-4">ë¡œê·¸ì¸</h2>
          
          <form id="loginForm" class="needs-validation" novalidate>
            <div class="mb-3">
              <label for="inputId" class="form-label">ì•„ì´ë””</label>
              <!-- id="inputId"ë¡œ ë³€ê²½ -->
              <input type="text" class="form-control" id="inputId" required autofocus>
            </div>

            <div class="mb-3">
              <label for="inputPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
              <!-- id="inputPassword"ë¡œ ë³€ê²½ -->
              <input type="password" class="form-control" id="inputPassword" required>
            </div>

            <p style="font-size: 15px; color: #666;">
              <span class="badge bg-secondary"  style="color: red;">ì•Œë¦¼</span> 
              <span style="font-size: 14px; margin: 0; text-align: left;">
              êµ¬ê¸€ì˜ firebase/Realtime Databaseì—ì„œ ì›¹ì„œë²„ë¥¼ ê°€ë™í•˜ê³ ìˆë‹¤. ì´ ì½”ë“œë“¤ì€ ì—…ë¡œë“œ ë°©ì‹ì´ ë‹¤ë¥¸ë° FTPë¡œ ê´€ë¦¬í•˜ì§€ì•Šê³  ë„ìŠ¤ í”„ë¡¬í”„íŠ¸ì—ì„œ ì—…ë¡œë“œ ì‹œí‚¨ë‹¤. HTMLì½”ë“œì´ì§€ë§Œ PHPì½”ë“œì²˜ëŸ¼ ë™ì í˜ì´ì§€ë¥¼ ë¬´ë‚œí•˜ê²Œ ìˆ˜í–‰í•œë‹¤.  C:\GitHub\terraone-site\publicì— ì›ë³¸ì½”ë“œê°€ ìˆê³  ì„œë²„ë¡œ ì—…ë°ì´íŠ¸ í• ê²½ìš°ì—ëŠ” ë„ìŠ¤í”„ë¡¬í”„íŠ¸ì—ì„œ í•´ë‹¹í´ë”ë¡œ ì´ë™í•´ì„œ ëª…ë ¹ì–´: " cd C:\GitHub\terraone-site " ë¡œ ê²½ë¡œì´ë™ì„ í•˜ê³  " firebase login " ìœ¼ë¡œ ë¡œê·¸ì¸(jeon2457@gamil.com) í™•ì¸ë˜ë©´ ëª…ë ¹ì–´: " firebase deploy " ë¡œ ì „ì²´ì½”ë“œë¥¼ ì—…ë°ì´íŠ¸í•œë‹¤. DB ë°ì´íƒ€ëŠ” ì½”ë“œì†ì— í¬í•¨ë˜ì–´ ì „ì†¡í•˜ëŠ” ë°©ì‹ì´ë‹¤. ì„œë²„ì£¼ì†Œ: https://console.firebase.google.com/ <br> ê³„ì •: jeon2457@gmail.com<br> ë¹„ë°€ë²ˆí˜¸: jeonsj8....@<br>í”„ë¡œì íŠ¸ëª…: terraone <br>ì „í™”ë²ˆí˜¸ ì—°ë½ë§ì€ ì¢Œì¸¡ë©”ë‰´ ë¹Œë“œ-Realtime Database-ë°ì´í„°ì— ë“¤ì–´ê°€ë©´ ëª¨ë“ ì •ë³´ê°€ DBì— ì €ì¥ë˜ì–´ìˆë‹¤, ê±°ë˜ëª…ì„¸ì„œ ì •ë³´(expense_table, income_table),ì˜ìˆ˜ì¦ì‚¬ì§„ ì •ë³´(images_table), íšŒì›ì—°ë½ë§ ì •ë³´(terraone)ì˜ í…Œì´ë¸”ë¡œ ì´ë£¨ì–´ì ¸ìˆê³ , ì´ë¯¸ì§€ì‚¬ì§„(ì˜ìˆ˜ì¦)ì€ ì‹¤ì œë¡œ Storage=> images/ì— ì €ì¥ë˜ì–´ìˆë‹¤.
            </span>


            

            <button type="submit" class="btn btn-primary w-100 mt-5">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
          </form>

          <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
          <div id="errorMsg" class="mt-3 text-center fw-bold text-danger"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ DB ê¸°ë°˜ ë¡œê·¸ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { getDatabase, ref, query, orderByChild, equalTo, get } 
      from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
    import { app } from "./js/firebase-config.js";
    import { requireGuest } from "./js/auth.js"; 

    // 1. ì´ë¯¸ ë¡œê·¸ì¸í–ˆìœ¼ë©´ ë©”ì¸ìœ¼ë¡œ ì´ë™
    requireGuest();

    const db = getDatabase(app);
    const loginForm = document.getElementById("loginForm");
    const errorMsg = document.getElementById("errorMsg");

    // 2. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      errorMsg.style.color = "blue";
      errorMsg.textContent = "ğŸ” DB ì¡°íšŒ ì¤‘...";

      const idVal = document.getElementById("inputId").value.trim();
      const pwVal = document.getElementById("inputPassword").value.trim();

      if (!idVal || !pwVal) {
        errorMsg.style.color = "red";
        errorMsg.textContent = "ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        return;
      }

      try {
        // ğŸ”¥ [í•µì‹¬] DBì—ì„œ ì•„ì´ë””ë¡œ ê²€ìƒ‰ (SELECT * FROM tel WHERE id = 'terraone')
        const usersRef = ref(db, 'terraone/tel');
        const q = query(usersRef, orderByChild('id'), equalTo(idVal));
        
        const snapshot = await get(q);

        if (snapshot.exists()) {
          // ì•„ì´ë””ê°€ ì¡´ì¬í•¨! ì´ì œ ë¹„ë°€ë²ˆí˜¸ ë¹„êµ
          let userFound = null;
          
          // ê²€ìƒ‰ëœ ê²°ê³¼ (ë³´í†µ 1ê°œì§€ë§Œ forEachë¡œ êº¼ëƒ„)
          snapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            
            // ë¹„ë°€ë²ˆí˜¸ ë¹„êµ (ì¼ì¹˜í•˜ë©´ ë¡œê·¸ì¸ ì„±ê³µ)
            if (String(userData.password) === String(pwVal)) {
              userFound = userData;
              userFound.key = childSnapshot.key; // í‚¤ê°’ë„ ì €ì¥
            }
          });

          if (userFound) {
            // âœ… ë¡œê·¸ì¸ ì„±ê³µ!
            console.log("ë¡œê·¸ì¸ ì„±ê³µ:", userFound);
            
            // ë ˆë²¨ ì²´í¬ (ê´€ë¦¬ìë§Œ í—ˆìš©í•œë‹¤ë©´)
            if (parseInt(userFound.level) < 10) {
               errorMsg.style.color = "red";
               errorMsg.textContent = "ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (Level < 10)";
               return;
            }

            errorMsg.style.color = "green";
            errorMsg.textContent = "âœ… ë¡œê·¸ì¸ ì„±ê³µ! ì´ë™í•©ë‹ˆë‹¤...";

            // ë¸Œë¼ìš°ì € ì„¸ì…˜(ì„ì‹œ ì €ì¥ì†Œ)ì— ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
            sessionStorage.setItem("currentUser", JSON.stringify(userFound));

            // í˜ì´ì§€ ì´ë™
            setTimeout(() => {
              window.location.href = "members.html";
            }, 500);

          } else {
            // ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼
            errorMsg.style.color = "red";
            errorMsg.textContent = "âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
          }

        } else {
          // ì•„ì´ë”” ì—†ìŒ
          errorMsg.style.color = "red";
          errorMsg.textContent = "âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.";
        }

      } catch (error) {
        console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
        errorMsg.style.color = "red";
        errorMsg.textContent = "ì‹œìŠ¤í…œ ì˜¤ë¥˜: " + error.message;
        
        // ë§Œì•½ ì¸ë±ìŠ¤ ì˜¤ë¥˜ê°€ ë‚œë‹¤ë©´ ì•ˆë‚´
        if (error.message.includes("Index not defined")) {
           alert("Firebase Console > Database > Rulesì—ì„œ .indexOn ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
      }
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>